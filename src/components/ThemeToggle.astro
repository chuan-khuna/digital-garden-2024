---
import { Moon, Sun, Leaf, Flame } from 'lucide-react'
import { Button } from '@/components/ui/button'

// theme list in `global.css`
const DEFAULT_THEME = 'nzk'
const THEMES = [DEFAULT_THEME, 'dark', 'nexus'] as const

// theme list in `astro.config.mjs`
const SYNTAX_HIGHLIGHTER_THEMES = {
  nzk: 'catppuccin-latte',
  dark: 'catppuccin-macchiato',
  nexus: 'catppuccin-macchiato',
} as const

const THEME_BUTTON_CSS = 'h-5 w-5 hidden'
---

<Button variant="ghost" size="icon" id="themeToggle">
  <Sun className={THEME_BUTTON_CSS} id={`${DEFAULT_THEME}Button`} />
  <Flame className={THEME_BUTTON_CSS} id="nexusButton" />
  <Moon className={THEME_BUTTON_CSS} id="darkButton" />
  <span class="sr-only">Toggle theme</span>
</Button>

<script
  is:inline
  define:vars={{ THEMES, DEFAULT_THEME, SYNTAX_HIGHLIGHTER_THEMES }}
>
  // Get stored theme or return default
  function getStoredTheme() {
    try {
      if (typeof localStorage === 'undefined') {
        return DEFAULT_THEME
      }

      const storedTheme = localStorage.getItem('theme')

      if (storedTheme && THEMES.includes(storedTheme)) {
        return storedTheme
      }

      return DEFAULT_THEME
    } catch (error) {
      return DEFAULT_THEME
    }
  }

  // Save theme to localStorage
  function saveTheme(themeName) {
    try {
      localStorage.setItem('theme', themeName)
    } catch (error) {
      // Silent fail - localStorage might be unavailable
    }
  }

  // Apply theme class to document element
  function applyThemeClass(themeName) {
    document.documentElement.classList.add(themeName)
  }

  // Set syntax highlighter theme via data attribute
  function applySyntaxHighlighterTheme(themeName) {
    const syntaxTheme =
      SYNTAX_HIGHLIGHTER_THEMES[themeName] ||
      SYNTAX_HIGHLIGHTER_THEMES[DEFAULT_THEME]
    document.documentElement.setAttribute('data-theme', syntaxTheme)
  }

  // Show specific theme button, hide others
  function updateThemeButton(themeName) {
    THEMES.forEach((theme) => {
      const button = document.getElementById(`${theme}Button`)
      if (!button) return

      if (theme === themeName) {
        button.classList.remove('hidden')
        button.classList.add('block')
      } else {
        button.classList.add('hidden')
        button.classList.remove('block')
      }
    })
  }

  // Get next theme in rotation
  function getNextTheme(currentTheme) {
    const currentIndex = THEMES.indexOf(currentTheme)
    const validIndex = currentIndex === -1 ? 0 : currentIndex
    const nextIndex = (validIndex + 1) % THEMES.length
    return THEMES[nextIndex]
  }

  // Replace old theme class with new one
  function replaceThemeClass(oldTheme, newTheme) {
    document.documentElement.classList.replace(oldTheme, newTheme)
  }

  // Initialize theme on page load
  function initializeTheme() {
    try {
      const theme = getStoredTheme()
      applyThemeClass(theme)
      applySyntaxHighlighterTheme(theme)
      updateThemeButton(theme)
      saveTheme(theme)
    } catch (error) {
      // Fallback to default on any error
      applyThemeClass(DEFAULT_THEME)
      applySyntaxHighlighterTheme(DEFAULT_THEME)
      updateThemeButton(DEFAULT_THEME)
      saveTheme(DEFAULT_THEME)
    }
  }

  // Reset to default theme (fallback handler)
  function resetToDefaultTheme() {
    try {
      THEMES.forEach((theme) => {
        document.documentElement.classList.remove(theme)
      })
      applyThemeClass(DEFAULT_THEME)
      applySyntaxHighlighterTheme(DEFAULT_THEME)
      updateThemeButton(DEFAULT_THEME)
      saveTheme(DEFAULT_THEME)
    } catch (error) {
      // Silent fail - we've done our best
    }
  }

  // Handle theme toggle click
  function handleThemeToggle() {
    try {
      const currentTheme = getStoredTheme()
      const nextTheme = getNextTheme(currentTheme)

      replaceThemeClass(currentTheme, nextTheme)
      applySyntaxHighlighterTheme(nextTheme)
      updateThemeButton(nextTheme)
      saveTheme(nextTheme)
    } catch (error) {
      resetToDefaultTheme()
    }
  }

  // Initialize theme immediately
  initializeTheme()

  // Attach click handler
  const toggleButton = document.getElementById('themeToggle')
  if (toggleButton) {
    toggleButton.addEventListener('click', handleThemeToggle)
  }
</script>
