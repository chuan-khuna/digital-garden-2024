---
import { Moon, Sun, Leaf, Flame } from 'lucide-react'
import { Button } from '@/components/ui/button'

const defaultTheme = 'nzk'

// theme name from `styles/globals.css`
const themes = [defaultTheme, 'dark', 'nexus']

const themeButtonCss = `h-5 w-5 hidden`
---

<Button variant="ghost" size="icon" id="themeToggle">
  <Sun className={themeButtonCss} id=`${defaultTheme}Button` />
  <Flame className={themeButtonCss} id="nexusButton" />
  <Moon className={themeButtonCss} id="darkButton" />
  <span class="sr-only">Toggle theme</span>
</Button>

<script is:inline define:vars={{ themes, defaultTheme }}>
  const theme = (() => {
    try {
      // check if localStorage is available and if a theme is set
      if (
        typeof localStorage !== 'undefined' &&
        localStorage.getItem('theme')
      ) {
        const storedTheme = localStorage.getItem('theme')
        // validate that the stored theme exists in our themes array
        if (themes.includes(storedTheme)) {
          // console.log('localStorage theme:', storedTheme)
          return storedTheme
        } else {
          // console.log('localStorage theme mismatch, using default theme:', defaultTheme)
          return defaultTheme
        }
      }

      // console.log('localStorage theme not set, using default theme:', defaultTheme)
      // return default theme, if no theme is set
      return defaultTheme
    } catch (error) {
      // console.error('Error reading theme from localStorage:', error)
      return defaultTheme
    }
  })()

  try {
    // initialise theme
    document.documentElement.classList.add(theme)
    // show the current theme button
    const themeButton = document.getElementById(`${theme}Button`)
    if (themeButton) {
      themeButton.classList.remove('hidden')
      themeButton.classList.add('block')
    }

    // set theme in localStorage
    window.localStorage.setItem('theme', theme)
  } catch (error) {
    // console.error('Error initializing theme:', error)
  }

  const handleToggleClick = () => {
    try {
      const storedTheme = localStorage.getItem('theme')
      currentIndex = themes.indexOf(storedTheme)

      // if stored theme is not found in themes array, reset to default
      if (currentIndex === -1) {
        currentIndex = themes.indexOf(defaultTheme)
      }

      // from current theme, get the next theme
      nextIndex = (currentIndex + 1) % themes.length
      nextTheme = themes[nextIndex]

      const element = document.documentElement

      // set theme
      localStorage.setItem('theme', nextTheme)

      // set theme class at the <html> element
      element.classList.replace(themes[currentIndex], nextTheme)

      // hide all buttons
      buttonClasses = themes.map((themeName) => `${themeName}Button`)
      for (themeName of themes) {
        const button = document.getElementById(`${themeName}Button`)
        if (button) {
          button.classList.add('hidden')
        }
      }

      // show theme button
      const button = document.getElementById(`${nextTheme}Button`)
      if (button) {
        button.classList.remove('hidden')
        button.classList.add('block')
      }
    } catch (error) {
      // console.error('Error toggling theme:', error)
      // fallback to default theme on error
      try {
        document.documentElement.classList.remove(...themes)
        document.documentElement.classList.add(defaultTheme)
        localStorage.setItem('theme', defaultTheme)

        // reset buttons
        for (themeName of themes) {
          const button = document.getElementById(`${themeName}Button`)
          if (button) {
            button.classList.add('hidden')
          }
        }
        const defaultButton = document.getElementById(`${defaultTheme}Button`)
        if (defaultButton) {
          defaultButton.classList.remove('hidden')
          defaultButton.classList.add('block')
        }
      } catch (fallbackError) {
        // console.error('Error applying fallback theme:', fallbackError)
      }
    }
  }

  document
    .getElementById('themeToggle')
    .addEventListener('click', handleToggleClick)
</script>
